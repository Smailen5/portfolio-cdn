name: Sync Files from Monorepo

on:
  # Trigger quando c'Ã¨ un push sul main della monorepo
  repository_dispatch:
    types: [monorepo-updated]

  # Trigger manuale per test
  workflow_dispatch:
    inputs:
      monorepo_branch:
        description: "Branch della monorepo da sincronizzare"
        required: true
        default: "main"

jobs:
  sync-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CDN repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Clone monorepo
        run: |
          chmod +x scripts/*.sh
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          export MONOREPO_NAME="${{ github.event.client_payload.monorepo }}"
          export MONOREPO_OWNER="${{ github.event.client_payload.owner }}"
          export BRANCH="${{ github.event.client_payload.branch }}"
          ./scripts/clone-monorepo.sh

      - name: Create public folder
        run: ./scripts/create-folder.sh

      - name: Copy projects.json
        run: ./scripts/copy-projects.sh

      - name: Update projects.json
        run: ./scripts/update-projects.sh

      - name: Copy full images
        run: ./scripts/copy-full-images.sh

      - name: Copy preview images
        run: ./scripts/copy-previews.sh

      - name: Copy screenshots
        run: ./scripts/copy-screenshots.sh

      - name: Check for changes
        id: check-changes
        run: ./scripts/check-changes.sh

      - name: Commit and push changes
        if: steps.check-changes.outputs.changes == 'true'
        run: ./scripts/commit-push.sh

      - name: Cleanup
        if: always()
        run: |
          rm -rf temp-monorepo
